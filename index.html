<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Magic 8 Ball - Firma Unknown Night</title>
<link href="https://fonts.googleapis.com/css2?family=Alef:wght@400;700&display=swap" rel="stylesheet"/>

<style>
  :root{ --fg:#fff; --muted:#aab0b6; }
  html,body{height:100%;margin:0}
  body{
    color:var(--fg);
    font:16px/1.4 "Alef", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    background: radial-gradient(120% 100% at 50% 0%, #1a1a1a 0%, #0b0b0b 55%, #000 100%);
    position:relative; overflow-x:hidden;
    padding: env(safe-area-inset-top, 0) env(safe-area-inset-right, 0) env(safe-area-inset-bottom, 0) env(safe-area-inset-left, 0);
  }

  /* noise */
  body::before{
    content:""; position:fixed; inset:-20% -20% -20% -20%; pointer-events:none;
    opacity:.09; mix-blend-mode:overlay; background-size:240px 240px;
    animation:grain 8s steps(10) infinite; z-index:0;
  }
  @keyframes grain{
    0%{transform:translate3d(0,0,0)}10%{transform:translate3d(-5%,-8%,0)}
    20%{transform:translate3d(6%,-2%,0)}30%{transform:translate3d(-3%,6%,0)}
    40%{transform:translate3d(8%,4%,0)}50%{transform:translate3d(-6%,2%,0)}
    60%{transform:translate3d(4%,-6%,0)}70%{transform:translate3d(-8%,-4%,0)}
    80%{transform:translate3d(2%,6%,0)}90%{transform:translate3d(-4%,2%,0)}
    100%{transform:translate3d(0,0,0)}
  }

  .wrap{min-height:100%; display:grid; grid-template-rows:1fr auto; z-index:1}

  /* ===================== FIXED UI CHROME (LTR only) ===================== */
  .ui-chrome{ position:fixed; inset:0; z-index:10; pointer-events:none; }
  .ui-chrome[dir="ltr"]{ direction:ltr; }      /* lock to LTR, ignore page dir */

  .ui-chrome .logo{ position:absolute; top:24px; height:auto; user-select:none;
    filter:drop-shadow(0 2px 6px rgba(0,0,0,.4)); pointer-events:auto; }
  .ui-chrome .logo.left{ left:20px; width:40px; }
  .ui-chrome .logo.right{ right:20px; width:120px; cursor:pointer; }

  /* language toggle – centered, below logos */
  .lang-toggle{
    position:fixed; left:50%; top:66px; transform:translateX(-50%);
    z-index:9; display:flex; gap:.25rem; align-items:center;
    background:rgba(255,255,255,0.05); backdrop-filter:blur(5px);
    border-radius:999px; padding:.25rem .4rem; outline:1px solid rgba(255,255,255,.12);
    font-size:13px;
  }
  .lang-toggle button{
    background:transparent; color:var(--fg); border:0; padding:.2rem .5rem;
    cursor:pointer; border-radius:999px; font-weight:700; font-family:"Alef",sans-serif;
  }
  .lang-toggle button.active{ background:rgba(255,255,255,.12); }

  /* stage */
  .stage{ display:grid; place-items:center; padding:clamp(20px,6vw,60px); }
  .ball-stack{ position:relative; width:min(62vh,64vw); aspect-ratio:1/1; }
  .ball-stack>*{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; pointer-events:none;}
  .ball-front{ z-index:3; } .answer-wrap{ z-index:2; display:grid; place-items:center; }
  .ball-back{ z-index:1; filter:drop-shadow(0 20px 30px rgba(0,0,0,.55)); }

  .answer{
    width:46%; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center;
    text-align:center; margin:auto; border-radius:50%;
    background:radial-gradient(50% 50% at 50% 38%,rgba(18,32,110,0.35) 0%, rgba(0,0,0,0) 70%);
    color:#eaf0ff; font-weight:700; line-height:1.18; padding:3.5%; transform:translateY(2%);
    text-shadow:0 0 6px rgba(40,100,255,.35); white-space:pre-line; opacity:0;
  }
  .answer.small  { font-size: clamp(12px, 1.25vw, 18px); }
  .answer.medium { font-size: clamp(13px, 1.6vw, 21px); }
  .answer.large  { font-size: clamp(14px, 1.9vw, 24px); }
  .answer.hidden { opacity:0; }
  .answer.show   { animation: fadeIn .35s ease-out forwards; }
  @keyframes fadeIn{ from{opacity:0; transform:translateY(2%) scale(.985);} to{opacity:1; transform:translateY(2%) scale(1);} }
  [dir="rtl"] .answer{ direction:rtl; }

  /* shake */
  @keyframes shake{
    0%{transform:translate(0,0) rotate(0)}15%{transform:translate(-2%,-1%) rotate(-2deg)}
    30%{transform:translate(1%,2%) rotate(2deg)}45%{transform:translate(-1%,1%) rotate(-1.2deg)}
    60%{transform:translate(1.4%,-1.2%) rotate(1.6deg)}75%{transform:translate(-.8%,.6%) rotate(-1deg)}
    100%{transform:translate(0,0) rotate(0)}
  }
  .shaking .ball-stack{ animation:shake .8s ease-in-out both; }

  /* controls */
  .controls{
    display:grid; grid-template-columns:1fr auto auto; align-items:center;
    gap:.6rem; padding:1rem clamp(1rem,5vw,3rem) 1.2rem;
    place-items:center;
  }
  .question{
    font-family:"Alef",sans-serif; font-size:.95rem;
    padding:.6rem .9rem; border-radius:16px; border:0; outline:2px solid #fff;
    background:#fff; color:#111;
    width:90%; max-width:720px; justify-self:center;
  }
  [dir="rtl"] .question{ text-align:right; }
  .btn{
    font-family:"Alef",sans-serif; font-weight:700; font-size:.95rem;
    padding:.65rem .95rem; border-radius:16px; border:0; cursor:pointer;
    background:#111; color:#fff; outline:1px solid rgba(255,255,255,.15);
    transition:transform .12s ease, outline-color .2s ease, background .2s ease;
  }
  .btn.primary{ background:#1b59ff; } .btn:disabled{ opacity:.45; cursor:not-allowed; }
  .btn:hover:not(:disabled){ transform:translateY(-1px); }

  /* mobile */
  @media (max-width:640px){
    .ui-chrome .logo.left{ left:14px; top:14px; width:36px; }
    .ui-chrome .logo.right{ right:14px; top:14px; width:96px; }
    .lang-toggle{ top:58px; font-size:12px; padding:.2rem .35rem; gap:.2rem; }

    .stage{ padding-top: clamp(78px, 14vh, 120px); }
    .ball-stack{ width:min(58vh, 92vw); }
    .answer{ width:52%; padding:4.5%; }

    .controls{
      grid-template-columns:1fr; gap:.5rem;
      padding:.7rem clamp(12px, 5vw, 24px) 1rem;
    }
    .question{ width:90%; max-width:none; font-size:.94rem; padding:.7rem .9rem; border-radius:15px; }
    .btn{ width:90%; padding:.85rem 1rem; font-size:.98rem; border-radius:16px; }
  }
</style>
</head>
<body>
  <!-- Fixed chrome that ignores RTL -->
  <div class="ui-chrome" dir="ltr">
    <img src="logo_f.svg" alt="F" class="logo left" />
    <img id="exportLogo" src="logo_night.svg" alt="Unknown Night (Export Log)" class="logo right" title="Download Q&A log" />
  </div>

  <!-- language toggle -->
  <div class="lang-toggle" aria-label="Language">
    <button type="button" data-lang="en" class="active">EN</button>
    <button type="button" data-lang="he">עברית</button>
  </div>

  <div class="wrap">
    <div class="stage" id="stage">
      <div class="ball-stack" id="ballStack" aria-live="polite">
        <img src="inside.svg" alt="" class="ball-back" />
        <div class="answer-wrap">
          <div id="answer" class="answer hidden medium"></div>
        </div>
        <img src="8 ball.svg" alt="Magic 8-Ball" class="ball-front" />
      </div>
    </div>

    <form class="controls" id="form" autocomplete="off" novalidate>
      <input id="question" class="question" type="text" required placeholder="Ask a yes or no question…" />
      <button id="shakeBtn" class="btn primary" type="submit">Shake</button>
      <button id="resetBtn" class="btn" type="button" disabled>Reset</button>
    </form>
  </div>

<script>
(()=>{
  /* noise */
  (function makeNoise(){
    try{
      const c=document.createElement('canvas'),s=240; c.width=c.height=s;
      const g=c.getContext('2d'), img=g.createImageData(s,s);
      for(let i=0;i<img.data.length;i+=4){ const v=(Math.random()*255)|0;
        img.data[i]=img.data[i+1]=img.data[i+2]=v; img.data[i+3]=255; }
      g.putImageData(img,0,0);
      document.body.style.setProperty('--noise',`url(${c.toDataURL()})`);
      (document.styleSheets[0]||document.head.appendChild(document.createElement('style')).sheet)
        .insertRule(`body::before{background-image:var(--noise)}`,0);
    }catch(e){}
  })();

  /* i18n */
  const STRINGS={
    en:{ askPlaceholder:"Ask a yes or no question…", shake:"Shake", askAgain:"Ask again", reset:"Reset",
      answers:["It is certain","Without a doubt","You may rely on it","Yes – definitely","Most likely","Outlook good","Signs point to yes","Yes","Reply hazy, try again","Ask again later","Better not tell you now","Cannot predict now","Concentrate and ask again","Don’t count on it","My reply is no","Outlook not so good","Very doubtful","Absolutely not","Only if you act","If you really want it"]},
    he:{ askPlaceholder:"שאל/י שאלה של כן או לא…", shake:"נער/י", askAgain:"שאל/י שוב", reset:"איפוס",
      answers:["בטוח לגמרי","ללא ספק","אפשר לסמוך על זה","כן – בהחלט","כנראה שכן","נראה מבטיח","הסימנים מצביעים על כן","כן","התשובה מעורפלת, נסה שוב","שאל שוב מאוחר יותר","עדיף לא לגלות עכשיו","אי אפשר לנבא עכשיו","התמקד/י ושאל/י שוב","אל תסמוך על זה","התשובה שלי היא לא","לא נראה מבטיח","בספק רב","ממש לא","רק אם תפעל/י","אם באמת תרצה/י – כן"]}
  };
  const SPECIAL_WRAP={
    en:{ "Concentrate and ask again":"Concentrate\nand ask\nagain" },
    he:{ "התשובה מעורפלת, נסה שוב":"התשובה\nמעורפלת,\nנסה\nשוב" }
  };

  let lang="en";
  const $=s=>document.querySelector(s);
  const stage=$("#stage"), answerEl=$("#answer"), form=$("#form");
  const questionEl=$("#question"), shakeBtn=$("#shakeBtn"), resetBtn=$("#resetBtn");
  const exportLogo=$("#exportLogo");

  document.querySelector('.lang-toggle').addEventListener('click',e=>{
    const btn=e.target.closest('button[data-lang]'); if(!btn) return; setLang(btn.dataset.lang);
  });

  function setLang(next){
    if(!STRINGS[next]) return;
    lang=next;
    document.documentElement.lang=next;
    document.documentElement.dir = next==="he" ? "rtl" : "ltr";  // UI flows rtl, chrome stays ltr
    questionEl.placeholder=STRINGS[lang].askPlaceholder;
    shakeBtn.textContent = answeredOnce ? STRINGS[lang].askAgain : STRINGS[lang].shake;
    resetBtn.textContent = STRINGS[lang].reset;
    document.querySelectorAll('.lang-toggle button').forEach(b=>b.classList.toggle('active', b.dataset.lang===next));
    if(answerEl.dataset.idx!==""){
      const idx=Number(answerEl.dataset.idx), pool=STRINGS[lang].answers;
      if(!Number.isNaN(idx)&&pool[idx]) setAnswer(pool[idx], idx);
    }
  }

  function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  function prepareText(raw){
    const special = SPECIAL_WRAP[lang] && SPECIAL_WRAP[lang][raw];
    if (special) return special;

    if (lang === "he") {
      return raw.split(/\s+/).flatMap(w=>w.split(/[\/–\-]+/)).filter(Boolean).join("\n");
    }
    const words=raw.split(/\s+/); const lines=[]; let line="";
    const max= raw.length>28 ? 11 : (raw.length>18 ? 13 : 99);
    for(const w of words){
      const nx=line?line+" "+w:w;
      if(nx.replace(/\W/g,"").length>max){ if(line) lines.push(line); line=w; } else line=nx;
    }
    if(line) lines.push(line);
    return lines.join("\n");
  }

  function fitTextUntilItFits(el){
    const cs=getComputedStyle(el); let size=parseFloat(cs.fontSize);
    el.style.fontSize=size+"px";
    let tries=16;
    while(tries-- && (el.scrollHeight>el.clientHeight || el.scrollWidth>el.clientWidth)){
      size*=0.92; el.style.fontSize=size+"px";
    }
  }

  function setAnswer(text, idx=null){
    answerEl.className="answer";
    const wrapped=prepareText(text);
    answerEl.innerHTML = escapeHTML(wrapped).replace(/\n/g,"<br>");
    answerEl.style.fontSize=""; answerEl.classList.add("large");
    fitTextUntilItFits(answerEl);
    void answerEl.offsetWidth; answerEl.classList.add("show");
    answerEl.setAttribute('aria-label', text);
    answerEl.dataset.idx = idx!==null ? String(idx) : "";
  }
  function clearAnswer(){
    answerEl.className="answer hidden"; answerEl.textContent=""; answerEl.dataset.idx=""; answerEl.style.fontSize="";
  }

  /* flow + logging */
  let isBusy=false, answeredOnce=false;
  const LOG_KEY="eightball_log_v1"; let log=[]; try{ log=JSON.parse(localStorage.getItem(LOG_KEY)||"[]"); }catch{}

  function addLog(q,a,lg){ const e={ts:new Date().toISOString(),lang:lg,question:q,answer:a};
    log.push(e); localStorage.setItem(LOG_KEY, JSON.stringify(log)); }

  async function shakeAndAnswer(){
    if(isBusy) return;
    const q=questionEl.value.trim(); if(!q){ questionEl.focus(); return; }
    isBusy=true;

    const y=window.scrollY; questionEl.blur(); shakeBtn.disabled=true; resetBtn.disabled=true;
    clearAnswer(); stage.classList.add('shaking');
    await new Promise(r=>setTimeout(r,880));
    const pool=STRINGS[lang].answers; const idx=Math.floor(Math.random()*pool.length); const ans=pool[idx];
    setAnswer(ans, idx); addLog(q, ans, lang);
    await new Promise(r=>setTimeout(r,120)); stage.classList.remove('shaking');

    answeredOnce=true; shakeBtn.textContent=STRINGS[lang].askAgain; resetBtn.disabled=false;
    shakeBtn.disabled=false; isBusy=false; window.scrollTo({top:y});
  }

  function resetAll(){
    if(isBusy) return; questionEl.value=""; clearAnswer(); answeredOnce=false;
    shakeBtn.textContent=STRINGS[lang].shake; resetBtn.disabled=true;
  }

  form.addEventListener('submit', e=>{ e.preventDefault(); shakeAndAnswer(); });
  resetBtn.addEventListener('click', resetAll);
  document.addEventListener('keydown', e=>{ if(e.key==="Escape") resetAll(); });

  // export via right logo
  exportLogo.addEventListener('click', ()=>{
    if(!log.length) return;
    const rows=[["timestamp","lang","question","answer"]].concat(log.map(r=>[r.ts,r.lang,r.question,r.answer]));
    const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\r\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="magic-8-ball_log.csv";
    document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),5000);
  });

  // init
  setLang(lang); clearAnswer();
})();
</script>
</body>
</html>
